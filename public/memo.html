<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Study Note</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --card:#1f2937;
      --paper:#0b1220;
      --line:rgba(56,189,248,0.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, rgba(56,189,248,0.12), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    header{
      padding:16px 16px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    header h1{
      font-size:18px;
      margin:0;
      letter-spacing:0.2px;
    }
    header .hint{color:var(--muted); font-size:12px}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 20px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .wrap{grid-template-columns:1fr}
    }
    .panel{
      background: rgba(17,24,39,0.65);
      border:1px solid rgba(148,163,184,0.18);
      border-radius:18px;
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .panel h2{font-size:14px; margin:0 0 10px; color:#cbd5e1}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{font-size:12px; color:var(--muted)}
    input[type="color"]{
      width:38px; height:32px; border:none; background:transparent; padding:0; cursor:pointer;
    }
    input[type="range"]{width:160px}
    .btn{
      appearance:none; border:none; cursor:pointer;
      background: rgba(56,189,248,0.15);
      border:1px solid rgba(56,189,248,0.35);
      color: var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      transition: transform .12s ease, background .12s ease;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(56,189,248,0.22);}
    .btn.secondary{
      background: rgba(148,163,184,0.10);
      border:1px solid rgba(148,163,184,0.22);
    }
    .btn.danger{
      background: rgba(248,113,113,0.12);
      border:1px solid rgba(248,113,113,0.35);
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(148,163,184,0.10);
      border:1px solid rgba(148,163,184,0.18);
      color:#cbd5e1;
      font-size:12px;
    }
    .divider{
      height:1px;
      background: rgba(148,163,184,0.14);
      margin:12px 0;
    }

    /* paper area */
    .paper{
      background: linear-gradient(transparent 31px, var(--line) 32px),
                  linear-gradient(90deg, transparent 31px, rgba(56,189,248,0.08) 32px),
                  var(--paper);
      background-size: 100% 32px, 32px 100%, auto;
      border:1px solid rgba(148,163,184,0.18);
      border-radius:18px;
      overflow:hidden;
      position:relative;
      min-height: 520px;
    }
    .paperTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background: rgba(2,6,23,0.45);
      border-bottom:1px solid rgba(148,163,184,0.14);
    }
    .paperTop input{
      width:100%;
      max-width: 520px;
      background: rgba(148,163,184,0.10);
      border:1px solid rgba(148,163,184,0.20);
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    .canvasWrap{
      position:relative;
      width:100%;
      height: calc(100% - 56px);
      min-height: 520px;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚ˆã‚Šæç”»ã‚’å„ªå…ˆ */
      cursor: crosshair;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(15,23,42,0.92);
      border:1px solid rgba(148,163,184,0.22);
      color:#e5e7eb;
      padding:10px 14px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .small{font-size:12px;color:var(--muted);line-height:1.5}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ğŸ“ æ‰‹æ›¸ããƒãƒ¼ãƒˆ</h1>
      <div class="hint">æŒ‡/ãƒšãƒ³ã§æ›¸ã‘ã‚‹ â†’ ä¿å­˜ â†’ æ¬¡å›å¾©å…ƒï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰</div>
    </div>
    <span class="pill" id="status">æœªä¿å­˜</span>
  </header>

  <div class="wrap">
    <aside class="panel">
      <h2>ãƒ„ãƒ¼ãƒ«</h2>

      <div class="row" style="margin-bottom:10px;">
        <label>ãƒšãƒ³è‰²</label>
        <input id="color" type="color" value="#e5e7eb" />
        <label>å¤ªã•</label>
        <input id="size" type="range" min="1" max="24" value="4" />
        <span class="pill" id="sizeLabel">4</span>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <button class="btn" id="penBtn">âœï¸ ãƒšãƒ³</button>
        <button class="btn secondary" id="eraserBtn">ğŸ§½ æ¶ˆã—ã‚´ãƒ </button>
      </div>

      <div class="divider"></div>

      <h2>ä¿å­˜ / å¾©å…ƒ</h2>
      <div class="row" style="margin-bottom:10px;">
        <button class="btn" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
        <button class="btn secondary" id="loadBtn">ğŸ”„ å¾©å…ƒ</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <button class="btn secondary" id="exportBtn">ğŸ–¼ï¸ PNGã§æ›¸ãå‡ºã—</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <button class="btn danger" id="clearBtn">ğŸ—‘ï¸ å…¨æ¶ˆã—</button>
      </div>

      <div class="divider"></div>
      <h2>ãƒ¡ãƒ¢</h2>
      <p class="small">
        ãƒ»ä¿å­˜ã¯ã“ã®ç«¯æœ«/ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã§ã™ã€‚<br>
        ãƒ»å‹é”ã¨å…±æœ‰ã—ãŸã„å ´åˆã¯ã€ŒPNGã§æ›¸ãå‡ºã—ã€ã‹ã€ã‚ã¨ã§ã‚µãƒ¼ãƒãƒ¼ä¿å­˜ï¼ˆNode/DBï¼‰ã«æ‹¡å¼µã§ãã¾ã™ã€‚
      </p>
    </aside>

    <section class="paper">
      <div class="paperTop">
        <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šæ­¯ã®è§£å‰–ï¼šå’¬é ­ã¨æºï¼‰" maxlength="60" />
      </div>
      <div class="canvasWrap">
        <canvas id="canvas"></canvas>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

  <script>
    // ====== è¨­å®š ======
    const STORAGE_KEY = "study-note-v1";
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    const colorEl = document.getElementById("color");
    const sizeEl = document.getElementById("size");
    const sizeLabel = document.getElementById("sizeLabel");
    const titleEl = document.getElementById("title");
    const statusEl = document.getElementById("status");
    const toastEl = document.getElementById("toast");

    const penBtn = document.getElementById("penBtn");
    const eraserBtn = document.getElementById("eraserBtn");
    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const exportBtn = document.getElementById("exportBtn");
    const clearBtn = document.getElementById("clearBtn");

    let mode = "pen"; // "pen" | "eraser"
    let drawing = false;
    let dirty = false;
    let last = { x: 0, y: 0, p: 0.5 };

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1200);
    }
    function setStatus(text, accent=false){
      statusEl.textContent = text;
      statusEl.style.borderColor = accent ? "rgba(56,189,248,0.45)" : "rgba(148,163,184,0.18)";
    }

    // ====== Canvas Resize (retinaå¯¾å¿œ) ======
    function resizeCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();

      // æ—¢å­˜å†…å®¹ã‚’é€€é¿
      const prev = canvas.width && canvas.height ? canvas.toDataURL("image/png") : null;

      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // èƒŒæ™¯ï¼ˆé€æ˜ã®ã¾ã¾ã§ã‚‚OKã€‚ç´™ã£ã½ãã™ã‚‹ãªã‚‰ç™½ã§å¡—ã‚‹ï¼‰
      // ctx.fillStyle = "#0b1220"; ctx.fillRect(0,0,rect.width,rect.height);

      if (prev){
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0, rect.width, rect.height);
        };
        img.src = prev;
      }
    }
    window.addEventListener("resize", resizeCanvas);

    // ====== Drawing utils ======
    function setTool(){
      penBtn.style.background = mode === "pen" ? "rgba(56,189,248,0.22)" : "rgba(56,189,248,0.15)";
      eraserBtn.style.background = mode === "eraser" ? "rgba(148,163,184,0.18)" : "rgba(148,163,184,0.10)";
      canvas.style.cursor = mode === "eraser" ? "cell" : "crosshair";
    }

    function getPoint(e){
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches && e.touches[0];
      const clientX = touch ? touch.clientX : e.clientX;
      const clientY = touch ? touch.clientY : e.clientY;
      const pressure = touch?.force ?? e.pressure ?? 0.5; // iOS/ä¸€éƒ¨ç«¯æœ«ã§æœ‰åŠ¹
      return {
        x: (clientX - rect.left),
        y: (clientY - rect.top),
        p: (pressure && pressure > 0) ? pressure : 0.5
      };
    }

    function beginStroke(pt){
      drawing = true;
      dirty = true;
      last = pt;
      ctx.beginPath();
      ctx.moveTo(pt.x, pt.y);
      setStatus("ç·¨é›†ä¸­â€¦", true);
    }

    function strokeTo(pt){
      if (!drawing) return;

      // ç­†åœ§ã£ã½ã„ï¼šforce ãŒå–ã‚Œã‚‹ãªã‚‰å°‘ã—åæ˜ 
      const base = Number(sizeEl.value);
      const w = Math.max(1, base * (0.6 + pt.p * 0.8));

      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.lineWidth = w;

      if (mode === "eraser"){
        ctx.globalCompositeOperation = "destination-out";
        ctx.strokeStyle = "rgba(0,0,0,1)";
      } else {
        ctx.globalCompositeOperation = "source-over";
        ctx.strokeStyle = colorEl.value;
      }

      ctx.lineTo(pt.x, pt.y);
      ctx.stroke();

      last = pt;
    }

    function endStroke(){
      if (!drawing) return;
      drawing = false;
      ctx.closePath();
      setStatus(dirty ? "æœªä¿å­˜" : "ä¿å­˜æ¸ˆã¿");
    }

    // Pointer Eventsï¼ˆãƒœã‚¿ãƒ³æŠ¼ã—ãªãŒã‚‰ã§ã‚‚æç”»ãŒé€”åˆ‡ã‚Œã«ãã„ï¼‰
    canvas.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      canvas.setPointerCapture(e.pointerId);
      beginStroke(getPoint(e));
    });
    canvas.addEventListener("pointermove", (e)=>{
      if (!drawing) return;
      e.preventDefault();
      strokeTo(getPoint(e));
    });
    canvas.addEventListener("pointerup", (e)=>{
      e.preventDefault();
      endStroke();
    });
    canvas.addEventListener("pointercancel", endStroke);

    // ====== UI ======
    sizeEl.addEventListener("input", ()=> sizeLabel.textContent = sizeEl.value);

    penBtn.addEventListener("click", ()=>{ mode="pen"; setTool(); toast("ãƒšãƒ³"); });
    eraserBtn.addEventListener("click", ()=>{ mode="eraser"; setTool(); toast("æ¶ˆã—ã‚´ãƒ "); });

    clearBtn.addEventListener("click", ()=>{
      if (!confirm("å…¨æ¶ˆã—ã™ã‚‹ï¼Ÿ")) return;
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0,0,rect.width,rect.height);
      dirty = true;
      setStatus("æœªä¿å­˜");
      toast("å…¨æ¶ˆã—");
    });

    function save(){
      const data = {
        title: titleEl.value ?? "",
        // ã“ã“ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç”»åƒã¨ã—ã¦ä¿å­˜ï¼ˆç°¡å˜ã§ç¢ºå®Ÿï¼‰
        image: canvas.toDataURL("image/png"),
        savedAt: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      dirty = false;
      setStatus("ä¿å­˜æ¸ˆã¿");
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw){
        toast("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—");
        return;
      }
      const data = JSON.parse(raw);
      titleEl.value = data.title ?? "";

      const rect = canvas.getBoundingClientRect();
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0,0,rect.width,rect.height);
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
        dirty = false;
        setStatus("ä¿å­˜æ¸ˆã¿");
        toast("å¾©å…ƒã—ã¾ã—ãŸ");
      };
      img.src = data.image;
    }

    saveBtn.addEventListener("click", save);
    loadBtn.addEventListener("click", load);

    exportBtn.addEventListener("click", ()=>{
      // èƒŒæ™¯ã‚’ç™½ã«ã—ãŸPNGãŒæ¬²ã—ã„å ´åˆã¯ä¸€æ™‚çš„ã«åˆæˆã—ã¦ã‚‚OK
      const a = document.createElement("a");
      const name = (titleEl.value || "note").replace(/[\\\/:*?"<>|]/g, "_");
      a.download = `${name}.png`;
      a.href = canvas.toDataURL("image/png");
      a.click();
      toast("PNGã‚’æ›¸ãå‡ºã—");
    });

    // ====== åˆæœŸåŒ– ======
    resizeCanvas();
    setTool();
    sizeLabel.textContent = sizeEl.value;

    // è‡ªå‹•å¾©å…ƒï¼ˆæ¬²ã—ã‘ã‚Œã°ONï¼‰
    load();

    // ãƒšãƒ¼ã‚¸é›¢è„±å‰ã®æ³¨æ„
    window.addEventListener("beforeunload", (e)=>{
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    });
  </script>
</body>
</html>
